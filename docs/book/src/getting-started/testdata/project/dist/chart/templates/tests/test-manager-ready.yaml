---
apiVersion: v1
kind: ServiceAccount
metadata:
  labels:
    app.kubernetes.io/managed-by: {{ .Release.Service }}
    app.kubernetes.io/name: {{ include "project.name" . }}
    helm.sh/chart: {{ .Chart.Name }}-{{ .Chart.Version | replace "+" "_" }}
    app.kubernetes.io/instance: {{ .Release.Name }}
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-weight": "-5"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
  name: {{ include "project.resourceName" (dict "suffix" "test-manager-ready" "context" $) }}
  namespace: {{ .Release.Namespace }}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  labels:
    app.kubernetes.io/managed-by: {{ .Release.Service }}
    app.kubernetes.io/name: {{ include "project.name" . }}
    helm.sh/chart: {{ .Chart.Name }}-{{ .Chart.Version | replace "+" "_" }}
    app.kubernetes.io/instance: {{ .Release.Name }}
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-weight": "-4"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
  name: {{ include "project.resourceName" (dict "suffix" "test-manager-ready" "context" $) }}
  namespace: {{ .Release.Namespace }}
rules:
  - apiGroups:
      - apps
    resources:
      - deployments
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - ""
    resources:
      - pods
    verbs:
      - get
      - list
      - watch
  {{- if .Values.certManager.enable }}
  - apiGroups:
      - cert-manager.io
    resources:
      - certificates
    verbs:
      - get
      - list
      - watch
  {{- end }}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  labels:
    app.kubernetes.io/managed-by: {{ .Release.Service }}
    app.kubernetes.io/name: {{ include "project.name" . }}
    helm.sh/chart: {{ .Chart.Name }}-{{ .Chart.Version | replace "+" "_" }}
    app.kubernetes.io/instance: {{ .Release.Name }}
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-weight": "-3"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
  name: {{ include "project.resourceName" (dict "suffix" "test-manager-ready" "context" $) }}
  namespace: {{ .Release.Namespace }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: {{ include "project.resourceName" (dict "suffix" "test-manager-ready" "context" $) }}
subjects:
  - kind: ServiceAccount
    name: {{ include "project.resourceName" (dict "suffix" "test-manager-ready" "context" $) }}
    namespace: {{ .Release.Namespace }}
---
apiVersion: v1
kind: Pod
metadata:
  labels:
    app.kubernetes.io/managed-by: {{ .Release.Service }}
    app.kubernetes.io/name: {{ include "project.name" . }}
    helm.sh/chart: {{ .Chart.Name }}-{{ .Chart.Version | replace "+" "_" }}
    app.kubernetes.io/instance: {{ .Release.Name }}
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
  name: {{ include "project.resourceName" (dict "suffix" "test-manager-ready" "context" $) }}
  namespace: {{ .Release.Namespace }}
spec:
  restartPolicy: Never
  serviceAccountName: {{ include "project.resourceName" (dict "suffix" "test-manager-ready" "context" $) }}
  containers:
    - name: test
      image: bitnami/kubectl:latest
      imagePullPolicy: IfNotPresent
      command:
        - /bin/sh
        - -ec
        - |
          echo "=================================="
          echo "Helm Chart Deployment Test"
          echo "=================================="
          echo "Release: {{ .Release.Name }}"
          echo "Namespace: {{ .Release.Namespace }}"
          echo "Chart: {{ .Chart.Name }}-{{ .Chart.Version }}"
          echo ""

          {{- if .Values.certManager.enable }}
          echo "Step 1/3: Validating cert-manager certificates..."
          if ! kubectl wait --for=condition=Ready certificate --all \
            -n {{ .Release.Namespace }} --timeout=3m 2>/dev/null; then
            echo "Warning: No certificates found or certificates not ready"
            echo "This may be expected if webhooks are not enabled or certificates are still being provisioned"
          else
            echo "SUCCESS: Certificates are ready"
          fi
          echo ""
          {{- else }}
          echo "Step 1/3: Skipping certificate validation (cert-manager not enabled)"
          echo ""
          {{- end }}

          echo "Step 2/3: Verifying manager deployment is available..."
          if ! kubectl wait --for=condition=Available deployment \
            -l control-plane=controller-manager \
            -n {{ .Release.Namespace }} --timeout=5m; then
            echo "ERROR: Manager deployment failed to become available"
            echo ""
            echo "Deployment status:"
            kubectl get deployments -n {{ .Release.Namespace }} -l control-plane=controller-manager || true
            echo ""
            echo "Pod status:"
            kubectl get pods -n {{ .Release.Namespace }} -l control-plane=controller-manager || true
            echo ""
            echo "Pod details:"
            kubectl describe pods -n {{ .Release.Namespace }} -l control-plane=controller-manager || true
            exit 1
          fi
          echo "SUCCESS: Manager deployment is available"
          echo ""

          echo "Step 3/3: Verifying manager pod is running..."
          POD_STATUS=$(kubectl get pods -l control-plane=controller-manager \
            -n {{ .Release.Namespace }} \
            -o jsonpath='{.items[0].status.phase}' 2>/dev/null || echo "")
          
          if [ -z "$POD_STATUS" ]; then
            echo "ERROR: No manager pod found"
            kubectl get pods -n {{ .Release.Namespace }} -l control-plane=controller-manager || true
            exit 1
          fi

          if [ "$POD_STATUS" != "Running" ]; then
            echo "ERROR: Manager pod is not running (status: $POD_STATUS)"
            echo ""
            echo "Pod status:"
            kubectl get pods -n {{ .Release.Namespace }} -l control-plane=controller-manager || true
            echo ""
            echo "Pod details:"
            kubectl describe pods -n {{ .Release.Namespace }} -l control-plane=controller-manager || true
            echo ""
            echo "Pod logs:"
            kubectl logs -n {{ .Release.Namespace }} -l control-plane=controller-manager --tail=50 || true
            exit 1
          fi
          echo "SUCCESS: Manager pod is running"
          echo ""

          echo "=================================="
          echo "All tests passed successfully!"
          echo "=================================="
      securityContext:
        allowPrivilegeEscalation: false
        capabilities:
          drop:
            - ALL
        readOnlyRootFilesystem: true
        runAsNonRoot: true
        runAsUser: 65532
        seccompProfile:
          type: RuntimeDefault
