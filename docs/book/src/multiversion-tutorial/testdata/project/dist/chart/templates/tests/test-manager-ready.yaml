---
apiVersion: v1
kind: ServiceAccount
metadata:
  labels:
    app.kubernetes.io/managed-by: {{ .Release.Service }}
    app.kubernetes.io/name: {{ include "project.name" . }}
    helm.sh/chart: {{ .Chart.Name }}-{{ .Chart.Version | replace "+" "_" }}
    app.kubernetes.io/instance: {{ .Release.Name }}
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-weight": "-5"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
  name: {{ include "project.resourceName" (dict "suffix" "test-manager-ready" "context" $) }}
  namespace: {{ .Release.Namespace }}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  labels:
    app.kubernetes.io/managed-by: {{ .Release.Service }}
    app.kubernetes.io/name: {{ include "project.name" . }}
    helm.sh/chart: {{ .Chart.Name }}-{{ .Chart.Version | replace "+" "_" }}
    app.kubernetes.io/instance: {{ .Release.Name }}
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-weight": "-4"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
  name: {{ include "project.resourceName" (dict "suffix" "test-manager-ready" "context" $) }}
  namespace: {{ .Release.Namespace }}
rules:
  - apiGroups:
      - apps
    resources:
      - deployments
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - ""
    resources:
      - pods
    verbs:
      - get
      - list
      - watch
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  labels:
    app.kubernetes.io/managed-by: {{ .Release.Service }}
    app.kubernetes.io/name: {{ include "project.name" . }}
    helm.sh/chart: {{ .Chart.Name }}-{{ .Chart.Version | replace "+" "_" }}
    app.kubernetes.io/instance: {{ .Release.Name }}
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-weight": "-3"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
  name: {{ include "project.resourceName" (dict "suffix" "test-manager-ready" "context" $) }}
  namespace: {{ .Release.Namespace }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: {{ include "project.resourceName" (dict "suffix" "test-manager-ready" "context" $) }}
subjects:
  - kind: ServiceAccount
    name: {{ include "project.resourceName" (dict "suffix" "test-manager-ready" "context" $) }}
    namespace: {{ .Release.Namespace }}
---
apiVersion: v1
kind: Pod
metadata:
  labels:
    app.kubernetes.io/managed-by: {{ .Release.Service }}
    app.kubernetes.io/name: {{ include "project.name" . }}
    helm.sh/chart: {{ .Chart.Name }}-{{ .Chart.Version | replace "+" "_" }}
    app.kubernetes.io/instance: {{ .Release.Name }}
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
  name: {{ include "project.resourceName" (dict "suffix" "test-manager-ready" "context" $) }}
  namespace: {{ .Release.Namespace }}
spec:
  restartPolicy: Never
  serviceAccountName: {{ include "project.resourceName" (dict "suffix" "test-manager-ready" "context" $) }}
  volumes:
    - name: tmp
      emptyDir: {}
  containers:
    - name: test
      image: {{ .Values.test.image.repository }}:{{ .Values.test.image.tag }}
      imagePullPolicy: {{ .Values.test.image.pullPolicy }}
      volumeMounts:
        - name: tmp
          mountPath: /tmp
      command:
        - /bin/sh
        - -ec
        - |
          echo "=================================="
          echo "Helm Chart Deployment Test"
          echo "=================================="
          echo "Release: {{ .Release.Name }}"
          echo "Namespace: {{ .Release.Namespace }}"
          echo "Chart: {{ .Chart.Name }}-{{ .Chart.Version }}"
          echo ""
          
          # Check if kubectl is already available in the image
          if command -v kubectl >/dev/null 2>&1; then
            echo "Using kubectl from image (pre-installed)"
          else
            # Download kubectl from official Kubernetes release
            KUBECTL_VERSION="{{ .Values.test.kubectlVersion }}"
            case "$(uname -m)" in
              x86_64) ARCH="amd64" ;;
              aarch64) ARCH="arm64" ;;
              armv7l) ARCH="arm" ;;
              *) ARCH="$(uname -m)" ;;
            esac
            echo "Downloading kubectl ${KUBECTL_VERSION} for ${ARCH}..."
            wget -q -O /tmp/kubectl "https://dl.k8s.io/release/${KUBECTL_VERSION}/bin/linux/${ARCH}/kubectl"
            chmod +x /tmp/kubectl
            export PATH="/tmp:$PATH"
            echo "kubectl ${KUBECTL_VERSION} installed successfully"
          fi
          echo ""

          echo "Step 1/2: Verifying manager deployment is available..."
          if ! kubectl wait --for=condition=Available deployment \
            -l control-plane=controller-manager \
            -n {{ .Release.Namespace }} --timeout=5m; then
            echo "ERROR: Manager deployment failed to become available"
            echo ""
            echo "Deployment status:"
            kubectl get deployments -n {{ .Release.Namespace }} -l control-plane=controller-manager || true
            echo ""
            echo "Pod status:"
            kubectl get pods -n {{ .Release.Namespace }} -l control-plane=controller-manager || true
            echo ""
            echo "Pod details:"
            kubectl describe pods -n {{ .Release.Namespace }} -l control-plane=controller-manager || true
            exit 1
          fi
          echo "SUCCESS: Manager deployment is available"
          echo ""

          echo "Step 2/2: Verifying manager pod is running..."
          POD_STATUS=$(kubectl get pods -l control-plane=controller-manager \
            -n {{ .Release.Namespace }} \
            -o jsonpath='{.items[0].status.phase}' 2>/dev/null || echo "")
          
          if [ -z "$POD_STATUS" ]; then
            echo "ERROR: No manager pod found"
            kubectl get pods -n {{ .Release.Namespace }} -l control-plane=controller-manager || true
            exit 1
          fi

          if [ "$POD_STATUS" != "Running" ]; then
            echo "ERROR: Manager pod is not running (status: $POD_STATUS)"
            echo ""
            echo "Pod status:"
            kubectl get pods -n {{ .Release.Namespace }} -l control-plane=controller-manager || true
            echo ""
            echo "Pod details:"
            kubectl describe pods -n {{ .Release.Namespace }} -l control-plane=controller-manager || true
            echo ""
            echo "Pod logs:"
            kubectl logs -n {{ .Release.Namespace }} -l control-plane=controller-manager --tail=50 || true
            exit 1
          fi
          echo "SUCCESS: Manager pod is running"
          echo ""

          echo "=================================="
          echo "All tests passed successfully!"
          echo "=================================="
      securityContext:
        allowPrivilegeEscalation: false
        capabilities:
          drop:
            - ALL
        readOnlyRootFilesystem: true
        runAsNonRoot: true
        runAsUser: 65532
        seccompProfile:
          type: RuntimeDefault
