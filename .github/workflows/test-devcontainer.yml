name: Test DevContainer Image

on:
  push:
    paths:
      - 'testdata/**'
      - '.github/workflows/test-devcontainer.yml'
      - 'pkg/plugins/golang/v4/scaffolds/internal/templates/devcontainer.go'
  pull_request:
    paths:
      - 'testdata/**'
      - '.github/workflows/test-devcontainer.yml'
      - 'pkg/plugins/golang/v4/scaffolds/internal/templates/devcontainer.go'

jobs:
  test-devcontainer:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Build and Run Dev Container Tests
        uses: devcontainers/ci@v0.3
        with:
          subFolder: testdata/project-v4
          runCmd: |
            # Verify Tools Installation
            echo "Verifying installed tools..."
            docker --version
            kind version
            kubebuilder version
            kubectl version --client
            go version
            echo "All required tools are installed"

            # Test Docker-in-Docker
            echo "Testing Docker-in-Docker functionality..."
            docker ps
            docker network ls
            docker run --rm hello-world
            echo "Docker is working inside devcontainer"

            # Test Kubebuilder Workflow
            echo "Testing Kubebuilder development workflow..."
            go mod tidy
            make all
            echo "make all passed"
            make docker-build IMG=controller:ci
            echo "make docker-build passed"

            # Test Kind Cluster Creation
            echo "Testing kind cluster creation..."
            kind create cluster --name test-cluster
            kubectl cluster-info --context kind-test-cluster
            kubectl get nodes
            kind delete cluster --name test-cluster
            echo "Kind cluster creation and deletion successful"

